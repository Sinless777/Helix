# .devcontainer/docker-compose.yaml
# Requires: Docker Compose v2.20+ for `include:` (docker compose version) 
# Intentionally no `version:` key (Compose Spec) 
# Project name pinned for predictable network/volume names.
name: helix

include:
  - ./docker/redis.yaml
  - ./docker/nginx.yaml
  - ./docker/cockroachdb.yaml
  - ./docker/mailpit.yaml

services:
  dev-container:
    image: mcr.microsoft.com/devcontainers/base:ubuntu
    container_name: dev-container
    init: true
    command: sleep infinity
    # Mount the repo into the dev container
    volumes:
      - ..:/workspaces/helix:cached
    environment:
      DB_URL: "postgresql://root@cockroachdb:26257/helix?sslmode=disable"
      REDIS_URL: "redis://redis:6379"
      MAILPIT_SMTP_HOST: "mailpit"
      MAILPIT_SMTP_PORT: "1025"
      API_BASE_URL: "http://nginx"
    networks:
      - helix
    depends_on:
      # Wait for health where available
      redis:
        condition: service_healthy
      cockroachdb:
        condition: service_healthy
      nginx:
        condition: service_started
      mailpit:
        condition: service_started

# Matches the external network used by nginx.yaml
# Create once if needed: `docker network create helix`
networks:
  helix:
    external: true
