services:
  cockroachdb:
    image: cockroachdb/cockroach:v25.2.0
    container_name: cockroachdb
    command:
      - start-single-node
      - --insecure
      - --listen-addr=0.0.0.0:26257
      - --http-addr=0.0.0.0:8080
      # dev defaults are fine; mount a volume for persistence
    ports:
      - "26257:26257"   # SQL
      - "8080:8080"     # DB Console
    volumes:
      - crdb-data:/cockroach/cockroach-data
    healthcheck:
      # Use the bundled CLI to run a trivial query against the local node
      test: ["CMD", "/cockroach/cockroach", "sql", "--insecure", "--host=localhost:26257", "-e", "SELECT 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  # one-shot init to create DB + user for dev
  cockroach-init:
    image: cockroachdb/cockroach:v25.2.0
    depends_on:
      cockroachdb:
        condition: service_healthy
    entrypoint: ["/bin/sh","-lc"]
    command: >
      '/cockroach/cockroach sql --insecure --host=cockroachdb:26257 -e "
        CREATE DATABASE IF NOT EXISTS helix;
        CREATE USER IF NOT EXISTS helix;
        GRANT ALL ON DATABASE helix TO helix;
      "'
    restart: "no"

volumes:
  crdb-data: