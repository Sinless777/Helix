# .devcontainer/docker/configs/nginx-api.conf
# Included by nginx.conf via: include /etc/nginx/conf.d/*.conf;

# Upstream to your Nest app inside the Docker network
upstream user_service {
  server user-service:3000;   # <- change if your service name/port differs
  keepalive 64;
}

server {
  listen 80;
  server_name helixaibot.local localhost 127.0.0.1;

  # --- GraphQL at /api/V1 (exact + prefix) ---
  # Exact match (the single GraphQL endpoint)
  location = /api/V1 {
    proxy_pass http://user_service;        # preserve URI as-is
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket upgrades (subscriptions)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;  # provided by nginx-settings.conf
    proxy_read_timeout 3600;
  }

  # Anything under /api/V1/ (for file uploads, subresources, etc.)
  location ^~ /api/V1/ {
    proxy_pass http://user_service;        # preserve /api/V1/<path>
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 3600;
  }

  # --- tRPC at /trpc/v1/* ---
  location ^~ /trpc/v1/ {
    proxy_pass http://user_service;        # preserve /trpc/v1/<procedure>
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # tRPC batching / optional WebSockets
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 3600;
  }

  # Optional: health check passthrough to Nest
  location = /healthz {
    proxy_pass http://user_service/healthz;
  }
}
