# .devcontainer/docker/configs/nginx-settings.conf
# Loaded inside the `http { ... }` context

##
# WebSocket helper (use in locations: `proxy_set_header Connection $connection_upgrade;`)
##
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

##
# Compression
##
gzip on;
gzip_vary on;
gzip_comp_level 5;
gzip_min_length 1024;
gzip_proxied any;
gzip_types
  text/plain
  text/css
  text/xml
  text/javascript
  application/javascript
  application/json
  application/xml
  application/xml+rss
  application/vnd.ms-fontobject
  application/x-font-ttf
  font/ttf
  font/otf
  image/svg+xml;

##
# Logging (structured JSON)
##
log_format main_json escape=json
  '{'
    '"time":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"x_forwarded_for":"$http_x_forwarded_for",'
    '"request_method":"$request_method",'
    '"scheme":"$scheme",'
    '"host":"$host",'
    '"uri":"$request_uri",'
    '"status":$status,'
    '"bytes_sent":$bytes_sent,'
    '"request_length":$request_length,'
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time",'
    '"connection":"$connection",'
    '"connection_requests":"$connection_requests",'
    '"user_agent":"$http_user_agent"'
  '}';

access_log /var/log/nginx/access.json main_json;

##
# Sensible proxy defaults (overridable per server/location)
##
proxy_http_version 1.1;
proxy_buffering off;
proxy_connect_timeout 60s;
proxy_send_timeout 3600s;
proxy_read_timeout 3600s;

##
# Global limits
##
client_max_body_size 10m;

##
# Real client IP (uncomment and set your proxy ranges if youâ€™re behind CF/ALB/etc.)
##
# set_real_ip_from 10.0.0.0/8;
# set_real_ip_from 172.16.0.0/12;
# set_real_ip_from 192.168.0.0/16;
# real_ip_header X-Forwarded-For;
# real_ip_recursive on;
