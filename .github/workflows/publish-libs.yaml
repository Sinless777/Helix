# .github/workflows/publish-libs.yml
name: ðŸš€ Publish Libraries (Nx + Self-Healing + Cache)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  packages: write
  id-token: write
  issues: write
  pull-requests: write

env:
  NPM_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_ACCESS_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      # â€“â€“â€“â€“â€“â€“ Cache node_modules â€“â€“â€“â€“â€“â€“
      - name: Cache npm modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-cache-${{ hashFiles('**/package-lock.json') }}-${{ runner.os }}
          restore-keys: |
            npm-cache-${{ hashFiles('**/package-lock.json') }}-
            npm-cache-

      - name: Setup Node.js & pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '9.15.4'

      - run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      # â€“â€“â€“â€“â€“â€“ Cache Nx build artifacts â€“â€“â€“â€“â€“â€“
      - name: Cache Nx computation results
        uses: actions/cache@v4
        with:
          path: |
            # adjust path if your workspace uses another location
            node_modules/.cache/nx
          key: nx-cache-${{ runner.os }}-${{ hashFiles('nx.json','**/project.json','**/workspace.json') }}-${{ github.sha }}
          restore-keys: |
            nx-cache-${{ runner.os }}-${{ hashFiles('nx.json','**/project.json','**/workspace.json') }}-
            nx-cache-${{ runner.os }}-

      # â€¦ Continue with your versioning/publish steps â€¦
      - name: Derive base/head SHAs
        id: setSHAs
        uses: nrwl/nx-set-shas@v4

      # etc â€¦ your build/test/publish logic â€¦
      - run: npx nx start-ci-run --no-distribution
      - run: npx nx affected -t lint test build --base=${{ steps.setSHAs.outputs.base }} --head=${{ steps.setSHAs.outputs.head }}
      - run: npx nx fix-ci
        if: always()

      # Version bump, publish, release steps follow â€¦

      # Clean up npm auth
      - if: always()
        run: rm -f ~/.npmrc
