# .github/workflows/publish-libs.yaml
name: ðŸš€ Publish Libraries (Nx + Self-Healing + Cache)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  packages: write
  id-token: write
  issues: write
  pull-requests: write

env:
  NPM_ACCESS_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: Cache pnpm store & modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.21.0'
          standalone: true

      - name: Cache Nx computation results
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache/nx
          key: nx-cache-${{ runner.os }}-${{ hashFiles('nx.json','**/project.json','**/workspace.json') }}-${{ github.sha }}
          restore-keys: |
            nx-cache-${{ runner.os }}-${{ hashFiles('nx.json','**/project.json','**/workspace.json') }}-

      - name: Derive base/head SHAs
        id: setSHAs
        uses: nrwl/nx-set-shas@v4
        with:
          gh-token: ${{ secrets.GITHUB_TOKEN }}
          main-branch-name: main
          remote: origin
          set-environment-variables-for-job: true
          error-on-no-successful-workflow: false
          last-successful-event: push
          working-directory: .

      - name: Set Git identity
        run: |
          git config user.name "Sinless777"
          git config user.email "tpierce@sinlessgamesllc.com"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all libraries/apps (ensure libs like hypertune are built)
        run: pnpm exec nx run-many --target=build --all

      - name: Build affected projects only
        run: |
          npx nx affected -t build --base=${{ steps.setSHAs.outputs.base }} --head=${{ steps.setSHAs.outputs.head }}

      - name: Lint & test affected projects
        run: |
          npx nx affected -t lint test --base=${{ steps.setSHAs.outputs.base }} --head=${{ steps.setSHAs.outputs.head }}

      - name: Bump version & generate CHANGELOG
        id: bump
        run: |
          set -euo pipefail
          pnpm exec standard-version --no-verify
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          pnpm exec node ./.github/scripts/releasenotes.js

      - name: Push version bump + tag
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          tags: true

      - name: Publish workspace packages
        run: pnpm -w -r publish --access public --no-git-checks

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Release ${{ steps.bump.outputs.new_version }}"
          tag_name: ${{ steps.bump.outputs.new_version }}
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
