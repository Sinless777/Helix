name: Sync Milestones

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/milestones.yaml'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies for script
        run: |
          npm install yaml
        # optionally you could lock this via package.json instead

      - name: Run milestone sync script
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { parse } = require('yaml');
            const { owner, repo } = context.repo;
            const file = '.github/milestones.yaml';

            if (!fs.existsSync(file)) {
              core.setFailed('milestones.yaml not found.');
              process.exit(1);
            }

            const yamlData = fs.readFileSync(file, 'utf8');
            const milestones = parse(yamlData);

            if (!Array.isArray(milestones)) {
              core.setFailed('milestones.yaml must contain an array.');
              process.exit(1);
            }

            const existing = await github.paginate(github.rest.issues.listMilestones, {
              owner,
              repo,
              state: 'all',
              per_page: 100
            });

            const mapByTitle = new Map(existing.map(m => [m.title, m]));
            const titlesInYaml = new Set();

            for (const m of milestones) {
              const title = String(m.title).trim();
              if (!title) continue;
              titlesInYaml.add(title);

              const description = m.description || '';
              const state = (m.state || 'open').toLowerCase() === 'closed' ? 'closed' : 'open';
              const due_on = m.due_on ? new Date(m.due_on).toISOString() : null;

              const current = mapByTitle.get(title);
              if (current) {
                // update if needed
                const needsUpdate = (
                  current.state !== state ||
                  (due_on && current.due_on !== due_on) ||
                  (description && (current.description || '') !== description)
                );
                if (needsUpdate) {
                  await github.rest.issues.updateMilestone({
                    owner,
                    repo,
                    milestone_number: current.number,
                    state,
                    description,
                    due_on
                  });
                }
              } else {
                // create new milestone
                await github.rest.issues.createMilestone({
                  owner,
                  repo,
                  title,
                  state,
                  description,
                  due_on
                });
              }
            }

            // optionally close ones not in yaml
            for (const m of existing) {
              if (!titlesInYaml.has(m.title) && m.state !== 'closed') {
                await github.rest.issues.updateMilestone({
                  owner,
                  repo,
                  milestone_number: m.number,
                  state: 'closed'
                });
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
