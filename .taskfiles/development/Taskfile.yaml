version: "3"

vars:
  MINIKUBE_PROFILE: helix
  MINIKUBE_DRIVER: docker
  MINIKUBE_CPUS: 4
  MINIKUBE_MEMORY: 4g
  MINIKUBE_HOSTNAME: local.dev.helixaibot.com

tasks:
  minikube-start:
    desc: Start a local Minikube cluster with Docker driver, custom hostname, and addons.
    cmds:
      - |
        minikube start -p {{.MINIKUBE_PROFILE}} \
          --driver={{.MINIKUBE_DRIVER}} \
          --container-runtime=containerd \
          --cpus={{.MINIKUBE_CPUS}} \
          --memory={{.MINIKUBE_MEMORY}}
      - |
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        echo "Minikube IP: ${IP}"
        echo "Add to /etc/hosts: ${IP} {{.MINIKUBE_HOSTNAME}}"
      - task: deploy-all

  minikube-stop:
    desc: Stop the Minikube cluster (keeps VM state).
    cmds:
      - minikube stop -p {{.MINIKUBE_PROFILE}}

  minikube-delete:
    desc: Delete the Minikube cluster (removes all state).
    cmds:
      - minikube delete -p {{.MINIKUBE_PROFILE}}

  minikube-hosts:
    desc: Add or update /etc/hosts entry for the Minikube IP and hostname.
    cmds:
      - |
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        HOST={{.MINIKUBE_HOSTNAME}}
        if [ -z "$IP" ]; then
          echo "Minikube is not running; start it first."
          exit 1
        fi
        sudo sh -c "sed -i.bak '/[[:space:]]${HOST//./\\.}$/d' /etc/hosts && echo \"$IP $HOST\" >> /etc/hosts"
        echo "Updated /etc/hosts with: $IP $HOST"

  deploy-all:
    desc: Reconcile all Flux kustomizations for dev cluster after minikube start
    cmds:
      # Ensure flux-system namespace exists before any Flux resources
      - kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f -
      # Install Flux CRDs first to avoid resource mapping errors
      - kubectl apply -k IaC/kubernetes/clusters/dev/flux-system/CRDs
      - kubectl wait --for=condition=Established --timeout=60s crd/gitrepositories.source.toolkit.fluxcd.io crd/helmrepositories.source.toolkit.fluxcd.io crd/ocirepositories.source.toolkit.fluxcd.io crd/kustomizations.kustomize.toolkit.fluxcd.io

      # Decrypt SOPS-encrypted manifests needed for bootstrapping
      - sops -d IaC/kubernetes/bootstrap/sops-age.sops.yaml > IaC/kubernetes/bootstrap/sops-age.yaml
      # Apply full flux-system stack (controllers, rbac, sync manifests)
      - kubectl apply -k IaC/kubernetes/bootstrap

      # Apply cluster-specific flux-system overlays
      - kubectl apply -k IaC/kubernetes/clusters/dev/flux-system
      - kubectl apply -k IaC/kubernetes/clusters/dev

      # Reconcile all kustomizations in order
      - flux reconcile source git flux-system -n flux-system
      - flux reconcile kustomization flux-system -n flux-system
      - flux reconcile kustomization cluster-vars -n flux-system || true
      - flux reconcile kustomization flux-helm-repositories -n flux-system || true

      # Deploy Cert-Manager first as other components may depend on it
      - flux reconcile kustomization cert-manager-stack -n flux-system || true
      - flux reconcile kustomization cilium -n flux-system || true
      - flux reconcile kustomization coredns -n flux-system || true
      - flux reconcile kustomization metrics-server -n flux-system || true
      - flux reconcile kustomization stakater-reloader -n flux-system || true
      - flux reconcile kustomization spegel -n flux-system || true
      - flux reconcile kustomization cloudflare-dns-stack -n flux-system || true
      - flux reconcile kustomization cloudflare-tunnel-stack -n flux-system || true
      - flux reconcile kustomization istio-stack -n flux-system || true

  reconcile-all:
    desc: Reconcile all Flux kustomizations for dev cluster
    cmds:
      # Reconcile all kustomizations in order
      - flux reconcile source git flux-system -n flux-system
      - flux reconcile kustomization flux-system -n flux-system
      - flux reconcile kustomization cluster-vars -n flux-system || true
      - flux reconcile kustomization flux-helm-repositories -n flux-system || true

      # Deploy Cert-Manager first as other components may depend on it
      - flux reconcile kustomization cert-manager-stack -n flux-system || true

      # kube system components
      - flux reconcile kustomization cilium -n flux-system || true
      - flux reconcile kustomization coredns -n flux-system || true
      - flux reconcile kustomization metrics-server -n flux-system || true
      - flux reconcile kustomization stakater-reloader -n flux-system || true
      - flux reconcile kustomization spegel -n flux-system || true

      # Networking components
      - flux reconcile kustomization cloudflare-dns-stack -n flux-system || true
      - flux reconcile kustomization cloudflare-tunnel-stack -n flux-system || true
      - flux reconcile kustomization istio-stack -n flux-system || true
