version: "3"

vars:
  MINIKUBE_PROFILE: helix
  MINIKUBE_DRIVER: docker
  MINIKUBE_CPUS: 4
  MINIKUBE_MEMORY: 4g
  MINIKUBE_HOSTNAME: local.dev.helixaibot.com

tasks:
  minikube-start:
    desc: Start a local Minikube cluster with Docker driver, custom hostname, and addons.
    cmds:
      - |
        minikube start -p {{.MINIKUBE_PROFILE}} \
          --driver={{.MINIKUBE_DRIVER}} \
          --container-runtime=containerd \
          --cpus={{.MINIKUBE_CPUS}} \
          --memory={{.MINIKUBE_MEMORY}} \
          --addons=ingress,metrics-server
      - minikube addons enable ingress -p {{.MINIKUBE_PROFILE}}
      - minikube addons enable metrics-server -p {{.MINIKUBE_PROFILE}}
      - |
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        echo "Minikube IP: ${IP}"
        echo "Add to /etc/hosts: ${IP} {{.MINIKUBE_HOSTNAME}}"
      - task: deploy-all

  minikube-stop:
    desc: Stop the Minikube cluster (keeps VM state).
    cmds:
      - minikube stop -p {{.MINIKUBE_PROFILE}}

  minikube-delete:
    desc: Delete the Minikube cluster (removes all state).
    cmds:
      - minikube delete -p {{.MINIKUBE_PROFILE}}

  minikube-hosts:
    desc: Add or update /etc/hosts entry for the Minikube IP and hostname.
    cmds:
      - |
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        HOST={{.MINIKUBE_HOSTNAME}}
        if [ -z "$IP" ]; then
          echo "Minikube is not running; start it first."
          exit 1
        fi
        sudo sh -c "sed -i.bak '/[[:space:]]${HOST//./\\.}$/d' /etc/hosts && echo \"$IP $HOST\" >> /etc/hosts"
        echo "Updated /etc/hosts with: $IP $HOST"

  deploy-all:
    desc: Reconcile all Flux kustomizations for dev cluster after minikube start
    cmds:
      - |
        # Ensure flux-system namespace exists before any Flux resources
        kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f -
        # Install Flux CRDs first to avoid resource mapping errors
        kubectl apply -k IaC/kubernetes/clusters/dev/flux-system/CRDs
        kubectl wait --for=condition=Established --timeout=60s crd/gitrepositories.source.toolkit.fluxcd.io crd/helmrepositories.source.toolkit.fluxcd.io crd/ocirepositories.source.toolkit.fluxcd.io crd/kustomizations.kustomize.toolkit.fluxcd.io
        # Idempotent creation of SOPS key secret for Flux decryption
        kubectl -n flux-system create secret generic flux-system-sops --from-file=sops.asc=/tmp/sops.asc --dry-run=client -o yaml | kubectl apply -f -
        # Apply full flux-system stack (controllers, rbac, sync manifests)
        kubectl apply -k IaC/kubernetes/bootstrap
        kubectl apply -k IaC/kubernetes/clusters/dev/flux-system
        kubectl apply -k IaC/kubernetes/clusters/dev

        # Reconcile all kustomizations in order
        flux reconcile source git flux-system -n flux-system
        flux reconcile kustomization flux-system -n flux-system
        flux reconcile kustomization cluster-vars -n flux-system || true
        flux reconcile kustomization flux-helm-repositories -n flux-system || true
        flux reconcile kustomization networking-base -n flux-system || true
        flux reconcile kustomization mesh-base -n flux-system || true
        flux reconcile kustomization platform-base -n flux-system || true
        flux reconcile kustomization storage-base -n flux-system || true
        flux reconcile kustomization observability-base -n flux-system || true
        flux reconcile kustomization security-base -n flux-system || true
        flux reconcile kustomization dr-chaos-base -n flux-system || true
        flux reconcile kustomization cost-feature-base -n flux-system || true
        flux reconcile kustomization apps-dev -n flux-system || true
