version: "3"

vars:
  MINIKUBE_PROFILE: helix
  MINIKUBE_DRIVER: docker
  MINIKUBE_CPUS: 4
  MINIKUBE_MEMORY: 8g
  MINIKUBE_HOSTNAME: local.dev.helixaibot.com

env:
  # Fail fast â€” safer for infra tasks
  SHELL: /bin/bash

tasks:
  minikube-start:
    desc: Start Minikube with required containerd settings + bootstrap cluster
    cmds:
      - |
        set -euo pipefail

        echo "ğŸš€ Starting Minikube cluster: {{.MINIKUBE_PROFILE}}"
        minikube start -p {{.MINIKUBE_PROFILE}} \
          --driver={{.MINIKUBE_DRIVER}} \
          --container-runtime=containerd \
          --cpus={{.MINIKUBE_CPUS}} \
          --memory={{.MINIKUBE_MEMORY}}

      - |
        echo "ğŸ”§ Ensuring containerd keeps unpacked layers..."
        minikube ssh -p {{.MINIKUBE_PROFILE}} '
          CFG="/etc/containerd/config.toml";
          if grep -q "discard_unpacked_layers = true" "$CFG"; then
            sudo sed -i "s/discard_unpacked_layers = true/discard_unpacked_layers = false/" "$CFG";
            sudo systemctl restart containerd;
          fi
        '

      - |
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        echo "â„¹ï¸  Minikube IP: $IP"
        echo "â„¹ï¸  Add to /etc/hosts: $IP {{.MINIKUBE_HOSTNAME}}"

      - task: deploy-all

  minikube-stop:
    desc: Stop the Minikube cluster
    cmds:
      - |
        echo "ğŸ›‘ Stopping Minikube..."
        minikube stop -p {{.MINIKUBE_PROFILE}}

  minikube-delete:
    desc: Delete the Minikube cluster
    cmds:
      - |
        echo "ğŸ”¥ Deleting Minikube cluster..."
        minikube delete -p {{.MINIKUBE_PROFILE}}

  minikube-hosts:
    desc: Add or update /etc/hosts entry for Minikube IP + hostname
    cmds:
      - |
        set -euo pipefail
        IP=$(minikube ip -p {{.MINIKUBE_PROFILE}})
        HOST={{.MINIKUBE_HOSTNAME}}

        if [ -z "$IP" ]; then
          echo "âŒ Minikube is not running."
          exit 1
        fi

        echo "ğŸ”§ Updating /etc/hosts for $HOST â†’ $IP"
        sudo sh -c "
          sed -i.bak '/[[:space:]]${HOST//./\\.}}$/d' /etc/hosts
          echo \"$IP $HOST\" >> /etc/hosts
        "
        echo "âœ” Updated /etc/hosts"

  deploy-all:
    desc: Bootstrap and fully deploy the entire dev cluster via Flux
    cmds:
      - |
        set -euo pipefail

        echo "ğŸ“¦ Installing Flux CRDs..."
        kubectl apply -k IaC/kubernetes/clusters/dev/flux-system/CRDs

        echo "â³ Waiting for Flux CRDs to establish..."
        kubectl wait --for=condition=Established --timeout=60s crd --all

      - |
        echo "ğŸ” Decrypting bootstrap SOPS keys..."
        sops -d IaC/kubernetes/bootstrap/sops-age.sops.yaml \
          > IaC/kubernetes/bootstrap/sops-age.yaml

      - |
        echo "ğŸš€ Bootstrapping Flux system..."
        kubectl apply -k IaC/kubernetes/bootstrap
        kubectl apply -k IaC/kubernetes/clusters/dev/flux-system
        kubectl wait --for=condition=Ready pods --all -n flux-system --timeout=180s

      - |
        echo "âš™ï¸  Applying cluster dev stack..."
        kubectl apply -k IaC/kubernetes/clusters/dev

      - |
        echo "ğŸ“œ Deploying core operators..."
        flux reconcile kustomization cert-manager-stack -n flux-system || true
        kubectl wait --for=condition=available --timeout=300s \
          deployment/cert-manager-webhook -n cert-manager || true

        flux reconcile kustomization cilium -n flux-system || true
        flux reconcile kustomization coredns -n flux-system || true
        flux reconcile kustomization metrics-server -n flux-system || true
        flux reconcile kustomization stakater-reloader -n flux-system || true
        flux reconcile kustomization spegel -n flux-system || true
        flux reconcile kustomization echo-server-stack -n flux-system || true

      - |
        echo "ğŸŒ Deploying networking stack..."
        flux reconcile kustomization cloudflare-dns-stack -n flux-system || true
        flux reconcile kustomization cloudflare-tunnel-stack -n flux-system || true
        flux reconcile kustomization istio-stack -n flux-system || true
        flux reconcile kustomization istio-config-stack -n flux-system || true

      - |
        echo "ğŸ“Š Deploying observability stack..."
        flux reconcile kustomization kube-prometheus -n flux-system || true

      - echo "ğŸ‰ Dev cluster bootstrap complete."

  reconcile-all:
    desc: Reconcile all Flux Kustomizations (dev cluster)
    cmds:
      - |
        set -euo pipefail
        echo "ğŸ” Reconciling entire dev stack..."
        flux reconcile source git flux-system -n flux-system
        flux reconcile kustomization flux-system -n flux-system
        flux reconcile kustomization cluster-vars -n flux-system || true
        flux reconcile kustomization flux-helm-repositories -n flux-system || true

        echo "âš™ï¸  Reconciling core..."
        flux reconcile kustomization cert-manager-stack -n flux-system || true
        kubectl wait --for=condition=available --timeout=300s \
          deployment/cert-manager-webhook -n cert-manager || true

        echo "ğŸ§± Reconciling kube-system..."
        flux reconcile kustomization cilium -n flux-system || true
        flux reconcile kustomization coredns -n flux-system || true
        flux reconcile kustomization metrics-server -n flux-system || true
        flux reconcile kustomization stakater-reloader -n flux-system || true
        flux reconcile kustomization spegel -n flux-system || true
        flux reconcile kustomization echo-server-stack -n flux-system || true

        echo "ğŸŒ Reconciling networking..."
        flux reconcile kustomization cloudflare-dns-stack -n flux-system || true
        flux reconcile kustomization cloudflare-tunnel-stack -n flux-system || true
        flux reconcile kustomization istio-stack -n flux-system || true
        flux reconcile kustomization istio-config-stack -n flux-system || true

        echo "ğŸ“Š Reconciling observability..."
        flux reconcile kustomization kube-prometheus -n flux-system || true

        echo "ğŸ‰ Full reconciliation complete."
