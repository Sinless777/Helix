apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pyroscope
  namespace: observability
  labels:
    app.kubernetes.io/name: pyroscope
    app.kubernetes.io/component: observability
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: observability
spec:
  interval: 30m
  releaseName: pyroscope
  chart:
    spec:
      chart: pyroscope
      version: ">=1.6.0 <1.8.0"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  install:
    remediation:
      retries: 3
  values:
    global:
      extraEnv:
        - name: ENVIRONMENT
          value: ${ENVIRONMENT}
    server:
      persistentVolume:
        enabled: true
        size: ${PYROSCOPE_PV:=50Gi}
      retention:
        value: ${PYROSCOPE_RETENTION:=14d}
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
    agent:
      enabled: true
      config:
        scrape_interval: 15s
        profiling:
          memory:
            enabled: true
          cpu:
            enabled: true
      extraEnv:
        - name: PYROSCOPE_SERVER_URL
          value: http://pyroscope.observability.svc.cluster.local
