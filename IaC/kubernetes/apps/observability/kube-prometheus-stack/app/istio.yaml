---
apiVersion: v1
kind: Service
metadata:
  name: envoy-internal
  namespace: network
  labels:
    app.kubernetes.io/name: envoy-internal
    app.kubernetes.io/component: service-mesh
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: service-mesh
spec:
  type: ClusterIP
  selector:
    app: envoy-external
    istio: envoy-external
  ports:
    - name: status-port
      port: 15021
      targetPort: 15021
      protocol: TCP
    - name: http2
      port: 80
      targetPort: 80
      protocol: TCP
    - name: https
      port: 443
      targetPort: 443
      protocol: TCP

---
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: envoy-internal
  namespace: network
  labels:
    app.kubernetes.io/name: envoy-internal
    app.kubernetes.io/component: service-mesh
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: service-mesh
spec:
  selector:
    istio: envoy-external
  servers:
    - name: observability-internal-http
      port:
        number: 80
        name: http-observability
        protocol: HTTP
      tls:
        httpsRedirect: true
      hosts:
        - "prometheus.${DOMAIN_3}"
        - "alertmanager.${DOMAIN_3}"
    - name: observability-internal-https
      port:
        number: 443
        name: https-observability
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: envoy-external-domain3-tls
        minProtocolVersion: TLSV1_3
        maxProtocolVersion: TLSV1_3
      hosts:
        - "prometheus.${DOMAIN_3}"
        - "alertmanager.${DOMAIN_3}"

---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: grafana
  namespace: observability
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: grafana
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: kube-prometheus-stack
spec:
  hosts:
    - "grafana.${DOMAIN_3}"
  gateways:
    - network/envoy-external
  http:
    - name: grafana
      match:
        - uri:
            prefix: /
      headers:
        request:
          set:
            x-forwarded-proto: https
      route:
        - destination:
            host: kube-prometheus-stack-grafana.observability.svc.cluster.local
            port:
              number: 80
      timeout: 30s

---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: kube-prometheus-stack-prometheus
  namespace: observability
  labels:
    app.kubernetes.io/name: kube-prometheus-stack-prometheus
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: kube-prometheus-stack
spec:
  hosts:
    - "prometheus.${DOMAIN_3}"
  gateways:
    - network/envoy-internal
  http:
    - name: prometheus
      match:
        - uri:
            prefix: /
      headers:
        request:
          set:
            x-forwarded-proto: https
      route:
        - destination:
            host: kube-prometheus-stack-prometheus.observability.svc.cluster.local
            port:
              number: 9090
      timeout: 60s

---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: kube-prometheus-stack-alertmanager
  namespace: observability
  labels:
    app.kubernetes.io/name: kube-prometheus-stack-alertmanager
    app.kubernetes.io/component: alertmanager
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: kube-prometheus-stack
spec:
  hosts:
    - "alertmanager.${DOMAIN_3}"
  gateways:
    - network/envoy-internal
  http:
    - name: alertmanager
      match:
        - uri:
            prefix: /
      headers:
        request:
          set:
            x-forwarded-proto: https
      route:
        - destination:
            host: kube-prometheus-stack-alertmanager.observability.svc.cluster.local
            port:
              number: 9093
      timeout: 60s
