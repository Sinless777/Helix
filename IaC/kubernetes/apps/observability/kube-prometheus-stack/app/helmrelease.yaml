apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
  labels:
    app.kubernetes.io/name: kube-prometheus-stack
    app.kubernetes.io/component: observability
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: observability

spec:
  interval: 1h0m0s
  retryInterval: 10m0s
  timeout: 10m0s
  releaseName: kube-prometheus-stack
  targetNamespace: observability
  prune: true

  chart:
    spec:
      chart: kube-prometheus-stack
      version: ">=57.0.0 <61.0.0"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system

  install:
    remediation:
      retries: 3
    createNamespace: false

  upgrade:
    remediation:
      retries: 3
      strategy: rollback

  uninstall:
    keepHistory: false

  # -----------------------------------------------------------------------
  # Values sourced from encrypted secrets + config map
  # -----------------------------------------------------------------------
  valuesFrom:
    - kind: Secret
      name: kube-prometheus-stack-secrets
      valuesKey: admin-user
      targetPath: grafana.adminUser

    - kind: Secret
      name: kube-prometheus-stack-secrets
      valuesKey: admin-password
      targetPath: grafana.adminPassword

    - kind: ConfigMap
      name: kube-prometheus-stack-config
      optional: true

  # -----------------------------------------------------------------------
  # Chart values
  # -----------------------------------------------------------------------
  values:
    global:
      rbac:
        create: true

    # ======================================================================
    # Grafana (Public: grafana.${DOMAIN_3})
    # ======================================================================
    grafana:
      enabled: true

      adminUser: null
      adminPassword: null

      service:
        type: ClusterIP
        port: 80
        portName: http

      podAnnotations:
        sidecar.istio.io/inject: "true"
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
        proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'

      ingress:
        enabled: false

      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          searchNamespace: observability
        datasources:
          enabled: true
        alerts:
          enabled: true

    # ======================================================================
    # Prometheus (Internal: prometheus.${DOMAIN_3})
    # ======================================================================
    prometheus:
      enabled: true

      ingress:
        enabled: false

      service:
        type: ClusterIP
        port: 9090

      prometheusSpec:
        externalUrl: "https://prometheus.${DOMAIN_3}"
        retention: 15d
        walCompression: true
        enableAdminAPI: false
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false

        podMetadata:
          annotations:
            sidecar.istio.io/inject: "true"
            sidecar.istio.io/rewriteAppHTTPProbers: "true"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'

    # ======================================================================
    # Alertmanager (Internal: alertmanager.${DOMAIN_3})
    # ======================================================================
    alertmanager:
      enabled: true

      ingress:
        enabled: false

      service:
        type: ClusterIP
        port: 9093

      alertmanagerSpec:
        externalUrl: "https://alertmanager.${DOMAIN_3}"
        replicas: 2
        retention: 120h

        podMetadata:
          annotations:
            sidecar.istio.io/inject: "true"
            sidecar.istio.io/rewriteAppHTTPProbers: "true"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'

        storage:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi

    # ======================================================================
    # Node Exporter
    # ======================================================================
    nodeExporter:
      enabled: true

    # ======================================================================
    # Kube State Metrics
    # ======================================================================
    kubeStateMetrics:
      enabled: true

    # ======================================================================
    # Kubernetes component monitors
    # ======================================================================
    kubeEtcd:
      enabled: true
    kubeControllerManager:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeProxy:
      enabled: true
    kubeDns:
      enabled: true

    # ======================================================================
    # Prometheus Operator / CRDs
    # ======================================================================
    prometheusOperator:
      enabled: true
      admissionWebhooks:
        enabled: true
        patch:
          podAnnotations:
            sidecar.istio.io/inject: "false"
        create:
          podAnnotations:
            sidecar.istio.io/inject: "false"

    serviceMonitor:
      enabled: true
    podMonitor:
      enabled: true
