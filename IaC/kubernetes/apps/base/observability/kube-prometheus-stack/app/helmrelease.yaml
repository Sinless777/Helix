apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
  labels:
    app.kubernetes.io/name: kube-prometheus-stack
    app.kubernetes.io/component: observability
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: kube-prometheus-stack

spec:
  interval: 1h
  timeout: 5m
  chart:
    spec:
      chart: kube-prometheus-stack
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      version: ">=57.0.0"

  releaseName: kube-prometheus-stack
  targetNamespace: observability
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      strategy: rollback
  uninstall:
    keepHistory: false

  valuesFrom:
    - kind: Secret
      name: kube-prometheus-stack-secrets
      valuesKey: grafana-admin-user
      targetPath: grafana.adminUser
    - kind: Secret
      name: kube-prometheus-stack-secrets
      valuesKey: grafana-admin-password
      targetPath: grafana.adminPassword
    - kind: ConfigMap
      name: kube-prometheus-stack-config
      optional: true

  values:
    ## ───────────────────────────────────────────────────────────────
    ## Global settings
    ## ───────────────────────────────────────────────────────────────
    global:
      rbac:
        create: true

    ## ───────────────────────────────────────────────────────────────
    ## Grafana
    ## Public Ingress: grafana.${DOMAIN_3}
    ## ───────────────────────────────────────────────────────────────
    grafana:
      enabled: true

      # Populated via valuesFrom
      adminUser: null
      adminPassword: null

      service:
        type: ClusterIP
        port: 80
        portName: http-web

      podAnnotations:
        sidecar.istio.io/inject: "true"
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
        proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'

      ingress:
        # Disabled in favor of Istio Gateway/VirtualService in this app
        enabled: false

      sidecar:
        dashboards:
          enabled: true
          label: "grafana_dashboard"
          searchNamespace: observability
        datasources:
          enabled: true
        alerts:
          enabled: true

    ## ───────────────────────────────────────────────────────────────
    ## Prometheus
    ## Internal Ingress: prometheus.${DOMAIN_3}
    ## ───────────────────────────────────────────────────────────────
    prometheus:
      enabled: true

      ingress:
        enabled: false

      service:
        type: ClusterIP
        port: 9090

      prometheusSpec:
        externalUrl: "https://prometheus.${DOMAIN_3}"
        retention: 15d
        walCompression: true
        enableAdminAPI: false
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false
        podMetadata:
          annotations:
            sidecar.istio.io/inject: "true"
            sidecar.istio.io/rewriteAppHTTPProbers: "true"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'

    ## ───────────────────────────────────────────────────────────────
    ## Alertmanager
    ## Internal Ingress: alertmanager.${DOMAIN_3}
    ## ───────────────────────────────────────────────────────────────
    alertmanager:
      enabled: true

      ingress:
        enabled: false

      service:
        type: ClusterIP
        port: 9093

      alertmanagerSpec:
        externalUrl: "https://alertmanager.${DOMAIN_3}"
        replicas: 2
        retention: "120h"
        podMetadata:
          annotations:
            sidecar.istio.io/inject: "true"
            sidecar.istio.io/rewriteAppHTTPProbers: "true"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":true}'
        storage:
          volumeClaimTemplate:
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 10Gi

    ## ───────────────────────────────────────────────────────────────
    ## Node Exporter
    ## ───────────────────────────────────────────────────────────────
    nodeExporter:
      enabled: true

    ## ───────────────────────────────────────────────────────────────
    ## Kube State Metrics
    ## ───────────────────────────────────────────────────────────────
    kubeStateMetrics:
      enabled: true

    ## ───────────────────────────────────────────────────────────────
    ## Additional Kubernetes components
    ## ───────────────────────────────────────────────────────────────
    kubeEtcd:
      enabled: true
    kubeControllerManager:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeDns:
      enabled: true
    kubeProxy:
      enabled: true

    ## ───────────────────────────────────────────────────────────────
    ## CRDs + Monitors
    ## ───────────────────────────────────────────────────────────────
    prometheusOperator:
      enabled: true
      admissionWebhooks:
        enabled: true
        patch:
          podAnnotations:
            sidecar.istio.io/inject: "false"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":false}'
        create:
          podAnnotations:
            sidecar.istio.io/inject: "false"
            proxy.istio.io/config: '{"holdApplicationUntilProxyStarts":false}'

    serviceMonitor:
      enabled: true
    podMonitor:
      enabled: true
