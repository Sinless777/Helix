---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: helix-flux-platform-admin
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
rules:
  # full control over Flux custom resources for platform bootstrap/admin
  - apiGroups:
      - source.toolkit.fluxcd.io
      - kustomize.toolkit.fluxcd.io
      - helm.toolkit.fluxcd.io
      - image.toolkit.fluxcd.io
    resources:
      - "*"
    verbs:
      - "*"
  # make sure platform admin can create namespaces, service accounts, etc.
  - apiGroups: ["", "apps", "rbac.authorization.k8s.io"]
    resources:
      - namespaces
      - serviceaccounts
      - roles
      - rolebindings
      - clusterroles
      - clusterrolebindings
    verbs:
      - "*"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: helix-flux-platform-admin-binding
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
subjects:
  - kind: Group
    name: helix-platform-admins  # Replace with your OIDC/LDAP group
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: helix-flux-platform-admin
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: helix-flux-tenant-readonly
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
rules:
  # read-only access for tenants to view Flux resources
  - apiGroups:
      - source.toolkit.fluxcd.io
      - kustomize.toolkit.fluxcd.io
      - helm.toolkit.fluxcd.io
    resources:
      - "*"
    verbs:
      - get
      - list
      - watch

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: helix-flux-tenant-readonly-binding
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
subjects:
  - kind: Group
    name: helix-tenant-readers  # Replace with your group for tenant readers
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: helix-flux-tenant-readonly
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: helix-flux-tenant-edit
  namespace: /* << define a namespace pattern / wildcard if supported */
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
rules:
  # Scoped editing rights in a tenant namespace for application deployment
  - apiGroups:
      - source.toolkit.fluxcd.io
      - kustomize.toolkit.fluxcd.io
      - helm.toolkit.fluxcd.io
    resources:
      - kustomizations
      - helmreleases
      - gitrepositories
      - helmrepositories
    verbs:
      - get
      - list
      - watch
      - create
      - patch
      - delete
  - apiGroups: [""]
    resources:
      - secrets
      - configmaps
    verbs:
      - create
      - get
      - list
      - patch

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: helix-flux-tenant-edit-binding
  namespace: /* tenant namespace placeholder */
  labels:
    app.kubernetes.io/part-of: helix-platform
    app.kubernetes.io/managed-by: fluxcd
    helix.ai/component: rbac
subjects:
  - kind: ServiceAccount
    name: gitops-reconciler  # or another designated SA for the team
    namespace: /* same namespace */
roleRef:
  kind: Role
  name: helix-flux-tenant-edit
  apiGroup: rbac.authorization.k8s.io
